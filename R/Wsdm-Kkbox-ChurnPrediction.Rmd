---
title: "WSDM KKBox - Churn Prediction"
author: "Manu Mathew"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    code_folding: hide
---

# Install and Load Packages

```{r setup}
knitr::opts_chunk$set(echo = TRUE)

Install_And_Load <- function(packages) {
    k <- packages[!(packages %in% installed.packages()[,"Package"])];
    if(length(k))
    {install.packages(k, repos='https://cran.rstudio.com/');}
    
    for(package_name in packages)
    {suppressMessages(library(package_name,character.only=TRUE, quietly = TRUE));}
}


Install_And_Load(c("RevoScaleR", "dplyr", "stringr",
                   "lubridate", "plotly"))


rxOptions(reportProgress = 3) # reduces the amount of output RevoScaleR produces
options(dplyr.print_max = 200)
options(dplyr.width = Inf) # shows all columns of a tbl_df object

directory <-  "E:/Documents/PersonalProjects/WsdmKKBox-ChurnPrediction/"
temp2 <- 20

```

# Data Ingestion 

Using Machine Learning Server (also known as Microsft R Server) we read in the following files - transactions, members, train and user log data. These files are saved as .xdf file on the disk and not as dataframe since they are huge. 

Few data manipulations were done on the fly
- Converting some columns to factor
- Converting character to date type

```{r eval=FALSE, include=TRUE}

# transactions.csv ####
csvPath <- paste0(directory, "Data/Base/transactions.csv") 
transactionsXdf <- paste0(directory, "Data/Processed/Xdf/transactions.xdf")

rxImport(inData = csvPath,
         outFile = transactionsXdf,
         colClasses = c(payment_method_id = 'factor',
                        is_auto_renew = 'factor',
                        is_cancel = 'factor'),
         transforms = list(transaction_date = as.Date(as.character(transaction_date), format="%Y%m%d"),
                           membership_expire_date = as.Date(as.character(membership_expire_date), format="%Y%m%d")),
         overwrite = TRUE,
         rowsPerRead = 5000000,
         reportProgress = 3)

# transactionsXdf <- RxXdfData(xdfPath)
# rxGetInfo(transactionsXdf, getVarInfo = TRUE, numRows = 10)


# members data ####

csvPath <- paste0(directory, "Data/Base/members_v3.csv")
membersXdf <- paste0(directory, "Data/Processed/Xdf/members.xdf")

rxImport(inData = csvPath,
         outFile = membersXdf,
         colClasses = c(city = 'factor',
                        gender = 'factor',
                        registered_via = 'factor'),
         transforms = list(registration_init_time = as.Date(as.character(registration_init_time), format="%Y%m%d")),
         overwrite = TRUE, 
         reportProgress = 3)

membersXdf <- RxXdfData(membersXdf)
# rxGetInfo(membersXdf, getVarInfo = TRUE, numRows = 10)
# rxSummary(~city, membersXdf)
# rxSummary(~registered_via, membersXdf)

rxFactors(inData = membersXdf, outFile = membersXdf,
          factorInfo = list(city = list(varName = "city",
                                        # levels = 1:21, 
                                        otherLevel = NULL,
                                        sortLevels = TRUE),
                            registered_via = list(varName = "registered_via",
                                                  # levels = 1:19, 
                                                  otherLevel = NULL,
                                                  sortLevels = TRUE)),
          # sortLevels = TRUE,
          overwrite = TRUE)

# rxGetInfo(membersXdf, getVarInfo = TRUE, numRows = 10)


# user logs data ####

csvPath <- paste0(directory, "Data/Base/user_logs.csv")
userLogsXdf <- paste0(directory, "Data/Processed/Xdf/userLogs.xdf")

rxImport(inData = csvPath,
         outFile = userLogsXdf,
         # colClasses = c(city = 'factor',
         #                gender = 'factor',
         #                registered_via = 'factor'),
         transforms = list(date = as.Date(as.character(date), format="%Y%m%d")),
         overwrite = TRUE)

userLogsXdf <- RxXdfData(userLogsXdf)
# rxGetInfo(userLogsXdf, getVarInfo = TRUE, numRows = 10)


# train data ####

csvPath <- paste0(directory, "Data/Base/train_v2.csv")
trainXdf <- paste0(directory, "Data/Processed/Xdf/train.xdf")
rxImport(inData = csvPath,
         outFile = trainXdf,
         colClasses = c(is_churn = 'factor'),
         overwrite = TRUE, 
         reportProgress = 3)

trainXdf <<- RxXdfData(trainXdf)
# rxGetInfo(trainXdf, getVarInfo = TRUE, numRows = 10)


```


The above code is set not to run while knitting as it might take some time. So I have to set the paths to xdf objects again.
```{r}
transactionsXdf <- RxXdfData(paste0(directory, "Data/Processed/Xdf/transactions.xdf"))
membersXdf <- RxXdfData(paste0(directory, "Data/Processed/Xdf/members.xdf"))
userLogsXdf <- RxXdfData(paste0(directory, "Data/Processed/Xdf/userLogs.xdf"))
trainXdf <- RxXdfData(paste0(directory, "Data/Processed/Xdf/train.xdf"))

```


Lets have a glimpse of these datasets

```{r}
# transactions ####
rxGetInfo(transactionsXdf, getVarInfo = TRUE, numRows = 5)

# members ####
rxGetInfo(membersXdf, getVarInfo = TRUE, numRows = 5)

# user log ####
rxGetInfo(userLogsXdf, getVarInfo = TRUE, numRows = 5)

# train ####
rxGetInfo(trainXdf, getVarInfo = TRUE, numRows = 5)

```


# EDA

## Churning Members' Profile (Members data & train data)

We shall merge members data and train data (labelled data).

```{reval=FALSE, include=TRUE}
churnMembersXdf <- paste0(directory, "Data/Processed/Xdf/churnMembers.xdf")

rxMerge(inData1 = membersXdf,
        inData2 = trainXdf,
        outFile = churnMembersXdf,
        matchVars = "msno",
        type = "inner")
```

Lets have a glimpse of it,

```{r}
churnMembersXdf <- paste0(directory, "Data/Processed/Xdf/churnMembers.xdf")

rxGetInfo(churnMembersXdf, getVarInfo = TRUE, numRows = 5)

rxSummary(~gender, 
          data = churnMembersXdf)

```


### Gender

```{r}


genderChurn <- rxCube(formula = ~ gender + is_churn,
                    data = churnMembersXdf,
                    returnDataFrame = TRUE)
summary(genderChurn)
print(genderChurn)

plotly::plot_ly(genderChurn, 
        x = ~gender) %>%
    add_trace(y = ~Counts,
              color = ~is_churn,
              # name = 'Absence Rate', 
              type = 'bar'
              # mode = 'lines'
              )


```

